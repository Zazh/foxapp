{% extends 'backoffice/base.html' %}

{% block title %}Feedback{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Feedback Requests</h1>
    <p class="text-gray-600">Customer inquiries</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow mb-6 p-4">
    <form method="get" class="flex gap-4 items-end">
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
            <input type="text" name="search" value="{{ search }}" placeholder="Name, phone, email..." 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="w-48">
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">All statuses</option>
                {% for value, label in statuses %}
                <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800">Filter</button>
        {% if search or current_status %}
        <a href="{% url 'backoffice:feedback_list' %}" class="px-4 py-2 text-gray-600 hover:text-gray-900">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for fb in feedbacks %}
            <tr class="hover:bg-gray-50" id="feedback-{{ fb.pk }}">
                <td class="px-6 py-4">
                    <div class="text-sm font-medium">{{ fb.created_at|date:"d M Y" }}</div>
                    <div class="text-sm text-gray-500">{{ fb.created_at|time:"H:i" }}</div>
                </td>
                <td class="px-6 py-4 font-medium">{{ fb.name }}</td>
                <td class="px-6 py-4">
                    <a href="tel:{{ fb.phone }}" class="text-blue-600 hover:underline">{{ fb.phone }}</a>
                </td>
                <td class="px-6 py-4 text-sm">{{ fb.email|default:"-" }}</td>
                <td class="px-6 py-4">
                    <select onchange="updateStatus({{ fb.pk }}, this.value)" 
                            class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500
                                {% if fb.status == 'new' %}bg-red-50
                                {% elif fb.status == 'in_progress' %}bg-yellow-50
                                {% elif fb.status == 'resolved' %}bg-green-50
                                {% else %}bg-gray-50{% endif %}">
                        {% for value, label in statuses %}
                        <option value="{{ value }}" {% if fb.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td class="px-6 py-4">
                    <button onclick="showDetails({{ fb.pk }})" class="text-blue-600 hover:underline text-sm">Details</button>
                </td>
            </tr>
            <!-- Details row (hidden by default) -->
            <tr id="details-{{ fb.pk }}" class="hidden bg-gray-50">
                <td colspan="6" class="px-6 py-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Message:</span>
                            <p class="mt-1">{{ fb.message|default:"No message"|linebreaks }}</p>
                        </div>
                        <div>
                            <span class="text-gray-500">Page URL:</span>
                            <p class="mt-1 text-xs break-all">{{ fb.page_url|default:"-" }}</p>
                            <span class="text-gray-500 mt-2 block">IP:</span>
                            <p class="mt-1">{{ fb.ip_address|default:"-" }}</p>
                            {% if fb.user %}
                            <span class="text-gray-500 mt-2 block">Registered user:</span>
                            <p class="mt-1"><a href="{% url 'backoffice:user_detail' fb.user.pk %}" class="text-blue-600 hover:underline">{{ fb.user.email }}</a></p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-gray-500 text-sm">Manager notes:</label>
                        <textarea id="notes-{{ fb.pk }}" rows="2" 
                                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                  placeholder="Add notes...">{{ fb.manager_notes }}</textarea>
                        <button onclick="saveNotes({{ fb.pk }})" class="mt-2 px-3 py-1 bg-gray-900 text-white rounded text-sm hover:bg-gray-800">Save notes</button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">No feedback requests</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="mt-6 flex justify-center gap-2">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
       class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Previous</a>
    {% endif %}
    <span class="px-4 py-2 text-gray-600">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}" 
       class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Next</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function showDetails(id) {
    const row = document.getElementById('details-' + id);
    row.classList.toggle('hidden');
}

function updateStatus(id, status) {
    fetch(`/backoffice/feedback/${id}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'status=' + status
    }).then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

function saveNotes(id) {
    const notes = document.getElementById('notes-' + id).value;
    fetch(`/backoffice/feedback/${id}/notes/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'notes=' + encodeURIComponent(notes)
    }).then(response => {
        if (response.ok) {
            alert('Notes saved');
        }
    });
}
</script>
{% endblock %}