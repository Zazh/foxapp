{% extends 'cabinet/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Settings" %}{% endblock %}

{% block scripts %}
    <script>
    // === Profile Form: Track Changes ===
    const profileForm = document.getElementById('profile-form');
    const saveBtn = document.getElementById('btn-save-profile');

    if (profileForm && saveBtn) {
        // Сохранить начальные значения
        const initialValues = {};
        profileForm.querySelectorAll('input:not([disabled])').forEach(input => {
            initialValues[input.name] = input.value;
        });

        // Функция проверки изменений
        function checkChanges() {
            let hasChanges = false;
            profileForm.querySelectorAll('input:not([disabled])').forEach(input => {
                if (input.value !== initialValues[input.name]) {
                    hasChanges = true;
                }
            });

            if (hasChanges) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.add('hover:bg-gray-800');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.remove('hover:bg-gray-800');
            }
        }

        // Слушать изменения
        profileForm.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', checkChanges);
        });

        // Изначально кнопка неактивна
        checkChanges();
    }

    // === Toast Notification ===
    function showToast(message, type = 'success') {
        // Удалить предыдущий toast если есть
        const existingToast = document.getElementById('toast-notification');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-2 opacity-0 ${
            type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
        }`;
        toast.innerHTML = `
            <div class="flex items-center gap-2">
                ${type === 'success'
                    ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                    : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
                }
                <span class="font-medium">${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        // Анимация появления
        setTimeout(() => {
            toast.classList.remove('translate-y-2', 'opacity-0');
        }, 10);

        // Автоскрытие через 3 секунды
        setTimeout(() => {
            toast.classList.add('translate-y-2', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // === Change Password Form ===
const passwordForm = document.getElementById('change-password-form');

if (passwordForm) {


    // Clear errors on input
    passwordForm.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            const errorDiv = this.closest('.flex.flex-col').querySelector('.input-error');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            this.closest('.input-floating').classList.remove('error');
        });
    });

    // Form submit
    passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('current-password');
        const newPassword = document.getElementById('new-password');
        const confirmPassword = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('btn-change-password');

        // Clear previous errors
        passwordForm.querySelectorAll('.input-error').forEach(el => {
            el.textContent = '';
            el.classList.add('hidden');
        });
        passwordForm.querySelectorAll('.input-floating').forEach(el => {
            el.classList.remove('error');
        });

        // Client-side validation
        let hasError = false;

        if (!currentPassword.value) {
            showFieldError(currentPassword, '{% trans "This field is required" %}');
            hasError = true;
        }

        if (!newPassword.value) {
            showFieldError(newPassword, '{% trans "This field is required" %}');
            hasError = true;
        } else if (newPassword.value.length < 8) {
            showFieldError(newPassword, '{% trans "At least 8 characters" %}');
            hasError = true;
        }

        if (!confirmPassword.value) {
            showFieldError(confirmPassword, '{% trans "This field is required" %}');
            hasError = true;
        } else if (newPassword.value !== confirmPassword.value) {
            showFieldError(confirmPassword, '{% trans "Passwords do not match" %}');
            hasError = true;
        }

        if (hasError) return;

        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

        try {
            const formData = new FormData(this);
            const response = await fetch(this.dataset.url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                // Закрыть модалку
                document.getElementById('modal-change-password').classList.remove('active');
                document.body.style.overflow = '';

                // Очистить форму
                passwordForm.reset();

                // Показать toast
                showToast(data.message, 'success');
            } else {
                // Показать ошибку
                if (data.field) {
                    const field = document.getElementById(data.field);
                    if (field) showFieldError(field, data.error);
                } else {
                    showFieldError(currentPassword, data.error);
                }
            }
        } catch (error) {
            showToast('{% trans "An error occurred. Please try again." %}', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '{% trans "Update password" %}';
        }
    });
}

// Helper: показать ошибку поля
function showFieldError(input, message) {
    const wrapper = input.closest('.flex.flex-col');
    const errorDiv = wrapper.querySelector('.input-error');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }
    input.closest('.input-floating').classList.add('error');
    input.focus();
}

// === Delete Account ===
const deleteBtn = document.getElementById('btn-delete-account');

if (deleteBtn) {
    deleteBtn.addEventListener('click', async function() {
        const url = this.dataset.url;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Disable button
        this.disabled = true;
        const originalText = this.innerHTML;
        this.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                // Редирект на главную
                window.location.href = data.redirect;
            } else {
                showToast(data.error || '{% trans "An error occurred." %}', 'error');
                this.disabled = false;
                this.innerHTML = originalText;
            }
        } catch (error) {
            showToast('{% trans "An error occurred. Please try again." %}', 'error');
            this.disabled = false;
            this.innerHTML = originalText;
        }
    });
}

    // Показать toast если есть сообщение от Django
    {% if messages %}
        {% for message in messages %}
            showToast('{{ message }}', '{{ message.tags }}');
        {% endfor %}
    {% endif %}
    </script>
{% endblock %}


{% block content %}
<section class="grid md:grid-cols-12 gap-x-4 px-4 md:px-4 min-h-[80vh]">
    <!-- Сайдбар / табы -->
    <div class="lg:col-span-3 xl:col-span-4 col-span-full lg:border-r border-gray-100 overflow-hidden -mx-4 md:mx-0">
        <!-- Фиксированная навигация (скрыта по умолчанию) -->
        <nav id="fixed-nav" class="fixed top-0 left-0 right-0 bg-white z-50 border-b border-gray-100 -translate-y-full transition-transform duration-300 lg:hidden">
            <ul class="flex overflow-x-auto gap-4 py-3 px-4 scrollbar-hide">
                <li class="shrink-0">
                    <a href="{% url 'cabinet-dashboard' %}" class="uppercase text-sm text-gray-700 font-bold tracking-wider whitespace-nowrap">
                        {% trans "Dashboard" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-history' %}" class="uppercase text-sm text-gray-700 font-bold tracking-wider whitespace-nowrap">
                        {% trans "History" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-billing' %}" class="uppercase text-sm text-gray-700 font-bold tracking-wider whitespace-nowrap">
                        {% trans "Billing" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-dashboard' %}" class="uppercase text-sm text-orange-500 font-bold tracking-wider whitespace-nowrap">
                        {% trans "Settings" %}
                    </a>
                </li>
            </ul>
        </nav>

        <nav class="sticky top-0 bg-white z-10 lg:static border-b lg:border-0 border-gray-100">
            <ul class="flex flex-row overflow-x-auto gap-4 py-3 px-4 md:px-0
                       lg:flex-col lg:overflow-visible lg:gap-2 lg:pt-6 lg:pr-16 lg:text-right
                       scrollbar-hide">
                <li class="shrink-0">
                    <a href="{% url 'cabinet-dashboard' %}" class="uppercase text-sm text-gray-700 hover:text-orange-500 font-bold tracking-wider whitespace-nowrap transition">
                        {% trans "Dashboard" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-history' %}" class="uppercase text-sm text-gray-700 hover:text-orange-500 font-bold tracking-wider whitespace-nowrap transition">
                        {% trans "History" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-billing' %}" class="uppercase text-sm text-gray-700 hover:text-orange-500 font-bold tracking-wider whitespace-nowrap transition">
                        {% trans "Billing" %}
                    </a>
                </li>
                <li class="shrink-0">
                    <a href="{% url 'cabinet-settings' %}" class="uppercase text-sm text-orange-500 font-bold tracking-wider whitespace-nowrap">
                        {% trans "Settings" %}
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="lg:col-span-8 xl:col-span-6 col-span-full">
        <div class="flex flex-col gap-6 py-8 md:py-12">
            <div>
                <h1 class="h1 leading-tight">{% trans 'Settings' %}</h1>
            </div>

            <div class="border-b border-gray-100">
                <div>
                    <h2 class="h4 font-bold text-gray-700">{% trans "Telegram" %}</h2>
                </div>
                <div class="flex justify-between items-center pt-2 pb-4">
                    <div>
                        {% if user.telegram_id %}
                            <span class="text-sm font-bold text-blue-500">
                                {% if user.telegram_username %}@{{ user.telegram_username }}{% else %}{% trans "Connected" %}{% endif %}
                            </span>
                        {% else %}
                            <span class="text-sm text-gray-500">{% trans "Not connected" %}</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if user.telegram_id %}
                            <button id="btn-disconnect-telegram" class="btn-card danger">{% trans "Disconnect" %}</button>
                        {% else %}
                            <button id="btn-connect-telegram" class="btn-card default">{% trans "Connect" %}</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <form id="profile-form" method="post" action="{% url 'cabinet-settings' %}" class="border-b border-gray-100">
                {% csrf_token %}
                <div>
                    <h2 class="h4 font-bold text-gray-700">{% trans 'Personal information' %}</h2>
                </div>
                <div class="pt-4 pb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" placeholder=" " required>
                                <label for="first_name">{% trans "First Name" %} <span class="text-red-500">*</span></label>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="text" id="middle_name" name="middle_name" value="{{ user.middle_name }}" placeholder=" ">
                                <label for="middle_name">{% trans "Middle Name" %}</label>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" placeholder=" " required>
                                <label for="last_name">{% trans "Last Name" %} <span class="text-red-500">*</span></label>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="text" id="id_card" name="id_card" value="{{ user.id_card }}" placeholder=" " required>
                                <label for="id_card">{% trans "ID Card" %} <span class="text-red-500">*</span></label>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="tel" id="phone" name="phone" value="{{ user.phone }}" placeholder=" ">
                                <label for="phone">{% trans "Phone" %}</label>
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <div class="input-floating">
                                <input type="email" id="email" value="{{ user.email }}" placeholder=" " disabled>
                                <label for="email">{% trans "Email" %}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col-reverse md:flex-row justify-between md:items-center gap-2 pb-6 md:pt-6">
                    <div>
                        <button type="submit" id="btn-save-profile" class="btn-card default opacity-50 cursor-not-allowed" disabled>
                            {% trans "Save" %}
                        </button>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-700">{% trans "Must match the information on your ID card" %}</span>
                    </div>
                </div>
            </form>

            <div class="border-b border-gray-100">
                <div>
                    <h2 class="h4 font-bold text-gray-700">{% trans "Security" %}</h2>
                </div>
                <div class="flex justify-between items-center pt-2 pb-4">
                    <div>
                        <span class="text-sm font-bold">{% trans "Password" %}</span>
                    </div>
                    <div>
                        <button class="btn-card default modal-open" data-modal="modal-change-password">{% trans "Change" %}</button>
                    </div>
                </div>
            </div>

            <div class="border-b border-gray-100">
                <div>
                    <h2 class="h4 font-bold text-gray-700">{% trans "Cancellation" %}</h2>
                </div>
                <div class="flex justify-between items-center pt-2 pb-4">
                    <div>
                        <span class="text-sm font-bold">{% trans "Forever delete profile" %}</span>
                    </div>
                    <div>
                        <button class="btn-card danger modal-open" data-modal="modal-delete-account">{% trans "Delete" %}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Модальное Change password -->
<div class="modal-overlay" id="modal-change-password">
  <div class="modal flex flex-col gap-8">
    <div class="modal-header px-4 md:px-6">
      <div class="flex flex-col">
        <div class="pb-1">
          <h3 class="h2">{% trans "Change password" %}</h3>
        </div>
      </div>
      <button class="modal-close [ absolute right-4 top-4 ] w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M1 1L13 13M1 13L13 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
      <form id="change-password-form" method="post" data-url="{% url 'cabinet-change-password' %}"
              class="modal-body px-4 md:px-6 flex flex-col gap-8"
              data-msg-required="{% trans 'This field is required' %}"
              data-msg-min-length="{% trans 'At least 8 characters' %}"
              data-msg-password-match="{% trans 'Passwords do not match' %}">

            {% csrf_token %}

            <div class="grid grid-cols-1 gap-4">
                <div class="flex flex-col gap-2">
                    <div class="input-floating input-password">
                        <input type="password" id="current-password" name="current_password" placeholder=" " required>
                        <label for="current-password">{% trans "Current password" %} <span class="text-red-500">*</span></label>
                        <button type="button" class="password-toggle">
                            <svg class="eye-open hidden" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <svg class="eye-closed" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M2 13L16 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-error text-xs text-red-500 font-bold hidden"></div>
                </div>

                <div class="flex flex-col gap-2">
                    <div class="input-floating input-password">
                        <input type="password" id="new-password" name="new_password" placeholder=" " required minlength="8">
                        <label for="new-password">{% trans "New password" %} <span class="text-red-500">*</span></label>
                        <button type="button" class="password-toggle">
                            <svg class="eye-open hidden" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <svg class="eye-closed" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M2 13L16 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-error text-xs text-red-500 font-bold hidden"></div>
                </div>

                <div class="flex flex-col gap-2">
                    <div class="input-floating input-password">
                        <input type="password" id="confirm-password" name="confirm_password" placeholder=" " required>
                        <label for="confirm-password">{% trans "Confirm new password" %} <span class="text-red-500">*</span></label>
                        <button type="button" class="password-toggle">
                            <svg class="eye-open hidden" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            <svg class="eye-closed" width="18" height="14" viewBox="0 0 18 14" fill="none">
                                <path d="M9 1C4.5 1 1.5 7 1.5 7C1.5 7 4.5 13 9 13C13.5 13 16.5 7 16.5 7C16.5 7 13.5 1 9 1Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="2.5" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M2 13L16 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="input-error text-xs text-red-500 font-bold hidden"></div>
                </div>

                <div>
                    <p class="text-xs text-gray-700 font-bold">{% trans "At least 8 characters, one number, one symbol." %}</p>
                </div>
            </div>
        </form>
        <div class="modal-footer">
            <div class="flex flex-col gap-2 flex-wrap px-4 md:px-6 pb-4 pt-2">
                <div>
                    <button type="submit" form="change-password-form" id="btn-change-password" class="btn-default black lg justify-center w-full flex">
                        {% trans "Update password" %}
                    </button>
                </div>
                <div class="flex justify-center">
                    <a href="{% url 'forgot_password' %}" class="text-gray-700 cursor-pointer hover:text-orange-500 py-2 font-bold text-center">
                        {% trans "Forgot your current password?" %}
                    </a>
                </div>
            </div>
        </div>
  </div>
</div>


<!-- Модальное Delete Account -->
<div class="modal-overlay" id="modal-delete-account">
  <div class="modal flex flex-col gap-8">
    {% csrf_token %}
    <div class="modal-header px-4 md:px-6">
      <div class="flex flex-col">
        <div class="pb-1">
          <h3 class="h2 text-center">{% trans "Delete Account" %}</h3>
        </div>
        <div>
          <p class="text-center leading-tight font-medium text-gray-700">
            {% trans "Confirm deletion of your profile. According to our policy, we will delete data related to you except for payment histories and receipts." %}
          </p>
        </div>
      </div>
      <button type="button" class="modal-close [ absolute right-4 top-4 ] w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M1 1L13 13M1 13L13 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-footer">
      <div class="flex flex-col gap-4 flex-wrap px-4 md:px-6 pb-4 pt-2">
        <div>
          <button type="button" id="btn-delete-account" data-url="{% url 'cabinet-deactivate' %}" class="btn-default danger lg justify-center w-full flex">
            {% trans "Yes, Delete my account" %}
          </button>
        </div>
        <div class="flex justify-center">
          <button type="button" class="modal-close text-gray-700 hover:text-gray-900 py-2 font-bold text-center">
            {% trans "Cancel" %}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}