(()=>{var o={timerInterval:null,guestLink:null,currentBookingId:null,generate(n,t){let e=document.getElementById(n);if(!e){console.error("Canvas not found:",n);return}new QRious({element:e,value:t,size:200,background:"#FDEFD3",foreground:"#000000",level:"M"})},startTimer(n,t){this.stopTimer();let e=Math.round(n*60),r=document.getElementById("qr-minutes"),s=()=>{let i=Math.floor(e/60),a=e%60;r&&(r.textContent=a>0?`${i}:${a.toString().padStart(2,"0")}`:i),e<=0&&(this.stopTimer(),t&&t()),e--};s(),this.timerInterval=setInterval(s,1e3)},stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)},getCsrfToken(){return document.querySelector("[name=csrfmiddlewaretoken]")?.value||""},async showUnitQR(n){this.currentBookingId=n;try{let e=await(await fetch("/visit/generate/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":this.getCsrfToken(),"X-Requested-With":"XMLHttpRequest"},body:`booking_id=${n}`})).json();e.success?(document.getElementById("qr-unit-number").textContent=e.full_code,document.getElementById("modal-qr-code")?.classList.add("active"),document.body.style.overflow="hidden",setTimeout(()=>{this.generate("qr-canvas",e.token),this.startTimer(e.expires_in,()=>{alert("QR code expired. Please generate a new one."),document.getElementById("modal-qr-code")?.classList.remove("active"),document.body.style.overflow=""})},100)):alert(e.error||"Failed to generate QR code")}catch(t){console.error("Error generating QR:",t),alert("Failed to generate QR code")}},async showGuestQR(){if(!this.currentBookingId){alert("No booking selected");return}try{let t=await(await fetch("/visit/generate-guest/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":this.getCsrfToken(),"X-Requested-With":"XMLHttpRequest"},body:`booking_id=${this.currentBookingId}`})).json();if(t.success){this.guestLink=t.guest_link,document.getElementById("guest-unit-number").textContent=t.full_code;let e=document.getElementById("guest-expires-in");e&&(e.textContent=t.expires_in),document.getElementById("modal-qr-code")?.classList.remove("active"),document.getElementById("modal-guest-qr")?.classList.add("active"),setTimeout(()=>{this.generate("guest-qr-canvas",t.token)},100)}else alert(t.error||"Failed to generate guest QR")}catch(n){console.error("Error generating guest QR:",n),alert("Failed to generate guest QR")}}};document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",n=>{let t=n.target.closest(".btn-show-qr");if(!t)return;let e=t.dataset.booking;e&&o.showUnitQR(e)}),document.getElementById("btn-share-guest")?.addEventListener("click",()=>{o.showGuestQR()}),document.getElementById("btn-copy-guest-link")?.addEventListener("click",async()=>{let n=document.getElementById("btn-copy-guest-link");try{await navigator.clipboard.writeText(o.guestLink),n.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Copied!
            `,setTimeout(()=>{n.innerHTML=`
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    Copy link
                `},2e3)}catch{alert("Failed to copy link")}}),document.querySelectorAll("#modal-qr-code .modal-close").forEach(n=>{n.addEventListener("click",()=>o.stopTimer())})});})();
